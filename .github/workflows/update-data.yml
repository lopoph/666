name: Sync Data
on:
  schedule:
    - cron: "*/1 * * * *"
  issue_comment:
    types: [created]

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Count Data
        run: |
          # 统计点赞数（匹配所有"like"评论）
          LIKE_COUNT=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/repos/lopoph/666/issues/1/comments" | grep -o '"body": "like"' | wc -l)
          
          # 统计访问数（总评论数+1）
          TOTAL_COMMENTS=$(curl -s -H "Authorization: token ${{ secrets.GH_TOKEN }}" \
            "https://api.github.com/repos/lopoph/666/issues/1/comments" | grep -o '"id":' | wc -l)
          VISIT_COUNT=$((TOTAL_COMMENTS + 1))
          
          # 写入data.json
          echo "{
            \"visitCount\": $VISIT_COUNT,
            \"likeCount\": $LIKE_COUNT,
            \"lastUpdateTime\": \"$(date +'%Y-%m-%d %H:%M:%S')\"
          }" > data.json

      - name: Commit Data
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update data: visit=$VISIT_COUNT, like=$LIKE_COUNT"
          file_pattern: "data.json"
