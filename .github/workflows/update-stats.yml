name: Process Likes and Update Stats

on:
  schedule:
    - cron: '*/2 * * * *'  # 每2分钟运行一次
  workflow_dispatch:       # 允许手动触发

jobs:
  process-like:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Process likes and update stats
      run: |
        # 创建完整的 Python 脚本来处理点赞逻辑
        cat > process_likes.py << 'EOF'
import json
import os
from datetime import datetime
import random

def process_likes():
    # 读取当前数据
    try:
        with open('data.json', 'r') as f:
            data = json.load(f)
    except:
        data = {"pageViews": 0, "likes": 0, "lastUpdated": ""}
    
    # 模拟检测点赞信号（每次运行有30%概率增加点赞）
    if random.random() < 0.3:
        data['likes'] = data.get('likes', 0) + 1
        print(f"🎉 检测到点赞信号！当前点赞数: {data['likes']}")
    
    # 增加访问量
    data['pageViews'] = data.get('pageViews', 0) + 1
    data['lastUpdated'] = datetime.now().isoformat()
    
    # 保存更新后的数据
    with open('data.json', 'w') as f:
        json.dump(data, f, indent=2)
    
    print(f"✅ 更新完成 - 访问量: {data['pageViews']}, 点赞数: {data['likes']}")

if __name__ == '__main__':
    process_likes()
EOF

        # 运行 Python 脚本
        python process_likes.py

    - name: Commit and push changes
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add data.json
        git diff --cached --quiet || git commit -m "🤖 自动处理点赞和访问统计 [skip ci]"
        git push
