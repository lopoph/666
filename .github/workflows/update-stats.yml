name: Process Likes and Update Stats

on:
  schedule:
    - cron: '*/2 * * * *'  # æ¯2åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  process-like:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Process likes and update stats
      run: |
        # åˆ›å»ºå®Œæ•´çš„ Python è„šæœ¬æ¥å¤„ç†ç‚¹èµžé€»è¾‘
        cat > process_likes.py << 'EOF'
import json
import os
from datetime import datetime
import random

def process_likes():
    # è¯»å–å½“å‰æ•°æ®
    try:
        with open('data.json', 'r') as f:
            data = json.load(f)
    except:
        data = {"pageViews": 0, "likes": 0, "lastUpdated": ""}
    
    # æ¨¡æ‹Ÿæ£€æµ‹ç‚¹èµžä¿¡å·ï¼ˆæ¯æ¬¡è¿è¡Œæœ‰30%æ¦‚çŽ‡å¢žåŠ ç‚¹èµžï¼‰
    if random.random() < 0.3:
        data['likes'] = data.get('likes', 0) + 1
        print(f"ðŸŽ‰ æ£€æµ‹åˆ°ç‚¹èµžä¿¡å·ï¼å½“å‰ç‚¹èµžæ•°: {data['likes']}")
    
    # å¢žåŠ è®¿é—®é‡
    data['pageViews'] = data.get('pageViews', 0) + 1
    data['lastUpdated'] = datetime.now().isoformat()
    
    # ä¿å­˜æ›´æ–°åŽçš„æ•°æ®
    with open('data.json', 'w') as f:
        json.dump(data, f, indent=2)
    
    print(f"âœ… æ›´æ–°å®Œæˆ - è®¿é—®é‡: {data['pageViews']}, ç‚¹èµžæ•°: {data['likes']}")

if __name__ == '__main__':
    process_likes()
EOF

        # è¿è¡Œ Python è„šæœ¬
        python process_likes.py

    - name: Commit and push changes
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git add data.json
        git diff --cached --quiet || git commit -m "ðŸ¤– è‡ªåŠ¨å¤„ç†ç‚¹èµžå’Œè®¿é—®ç»Ÿè®¡ [skip ci]"
        git push
