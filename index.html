<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>访问计数&点赞页面</title>
    <style>
        body { max-width: 600px; margin: 50px auto; text-align: center; font-family: Arial, sans-serif; }
        .data-box { margin: 30px 0; font-size: 20px; }
        .data-item { margin: 15px 0; }
        #likeBtn { padding: 12px 30px; font-size: 18px; background: #007bff; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        #likeBtn:disabled { background: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>访问计数 & 点赞功能演示</h1>
    <div class="data-box">
        <div class="data-item">当前访问次数：<span id="visitCount">加载中...</span></div>
        <div class="data-item">当前点赞次数：<span id="likeCount">加载中...</span></div>
    </div>
    <button id="likeBtn" onclick="handleLike()">点赞</button>

    <script>
        // 已替换为你的信息
        const USER = "lopoph";
        const REPO = "666";
        const ISSUE_ID = "1";
        const DATA_URL = `https://${USER}.github.io/${REPO}/data.json`;
        const DISPATCH_URL = `https://api.github.com/repos/${USER}/${REPO}/dispatches`;

        window.onload = async function() {
            await loadData();
            await triggerUpdate("visit");
        };

        async function loadData() {
            try {
                const res = await fetch(DATA_URL);
                const data = await res.json();
                document.getElementById("visitCount").textContent = data.visitCount || 0;
                document.getElementById("likeCount").textContent = data.likeCount || 0;
            } catch (err) {
                console.error("加载数据失败：", err);
                document.getElementById("visitCount").textContent = "加载失败";
                document.getElementById("likeCount").textContent = "加载失败";
            }
        }

        async function triggerUpdate(type) {
            if (type === "like" && localStorage.getItem("hasLiked")) {
                alert("24小时内只能点赞1次哦！");
                document.getElementById("likeBtn").disabled = true;
                return;
            }

            try {
                await fetch(DISPATCH_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        event_type: `update_${type}`,
                        client_payload: { issue_id: ISSUE_ID }
                    })
                });

                if (type === "like") {
                    localStorage.setItem("hasLiked", "true");
                    localStorage.setItem("likeExpire", Date.now() + 24 * 60 * 60 * 1000);
                    document.getElementById("likeBtn").disabled = true;
                    setTimeout(loadData, 1500);
                } else {
                    setTimeout(loadData, 1000);
                }
            } catch (err) {
                console.error(`更新${type}失败：`, err);
                alert(`更新${type === "visit" ? "访问数" : "点赞数"}失败，请稍后再试！`);
            }
        }

        function handleLike() {
            triggerUpdate("like");
        }

        if (localStorage.getItem("likeExpire") && Date.now() > localStorage.getItem("likeExpire")) {
            localStorage.removeItem("hasLiked");
            localStorage.removeItem("likeExpire");
        } else if (localStorage.getItem("hasLiked")) {
            document.getElementById("likeBtn").disabled = true;
        }
    </script>
</body>
</html>
