<!DOCTYPE html>
<html>
<body>
  <div>访问量: <span id="visitCount" class="count">加载中...</span></div>
  <button onclick="updateCount('like')" id="likeBtn">点赞</button>
  <div>点赞数: <span id="likeCount" class="count">加载中...</span></div>
  <div id="errorMsg" style="color: red; margin-top: 10px; display: none;"></div>

  <script>
    const CONFIG = {
      REPO_OWNER: "lopoph",
      REPO_NAME: "666",
      GIST_ID: "eab3ee8d8cd26c542f06ca09004b82d9",
      FILE_NAME: "count.json"
    };

    // 工具函数：显示错误
    function showError(msg) {
      const errorEl = document.getElementById("errorMsg");
      errorEl.textContent = "错误：" + msg;
      errorEl.style.display = "block";
      document.querySelectorAll(".count").forEach(el => el.textContent = "加载失败");
    }

    // 工具函数：显示加载状态
    function showLoading(type) {
      if (type) {
        document.getElementById(`${type}Count`).textContent = "更新中...";
      } else {
        document.querySelectorAll(".count").forEach(el => el.textContent = "加载中...");
      }
      document.getElementById("errorMsg").style.display = "none";
    }

    // 初始化计数（带验证）
    async function initCount() {
      showLoading();
      try {
        const res = await fetch(`https://gist.githubusercontent.com/${CONFIG.REPO_OWNER}/${CONFIG.GIST_ID}/raw/${CONFIG.FILE_NAME}`);
        if (!res.ok) throw new Error(`获取计数失败，状态码=${res.status}`);
        
        const data = await res.json();
        // 验证计数字段
        if (typeof data.visit !== "number" || typeof data.like !== "number") {
          throw new Error("计数数据格式错误");
        }

        document.getElementById("visitCount").textContent = data.visit;
        document.getElementById("likeCount").textContent = data.like;
      } catch (err) {
        showError(err.message);
      }
    }

    // 更新计数（带全链路验证）
    async function updateCount(type) {
      showLoading(type);
      document.getElementById("likeBtn").disabled = true;
      try {
        // 验证类型
        if (!["visit", "like"].includes(type)) throw new Error("计数类型无效");

        // 触发GitHub Actions
        const res = await fetch(`https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/dispatches`, {
          method: "POST",
          headers: {
            "Accept": "application/vnd.github+json",
            "X-GitHub-Api-Version": "2022-11-28"
          },
          body: JSON.stringify({
            event_type: "update-count",
            client_payload: { type: type }
          })
        });

        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(`触发更新失败：${res.status} - ${errData.message || "未知错误"}`);
        }

        // 等待Actions执行后刷新
        setTimeout(async () => {
          await initCount();
          document.getElementById("likeBtn").disabled = false;
        }, 1500);
      } catch (err) {
        showError(err.message);
        document.getElementById("likeBtn").disabled = false;
      }
    }

    // 页面加载时初始化
    window.onload = initCount;
  </script>
</body>
</html>
